{% extends "base.html" %}
{% block title %}ë„¤ì´ë²„ ë§›ì§‘ ê²€ìƒ‰ | finals ë§›ì§‘{% endblock %}

{% block content %}
<h2 style="margin-bottom:12px;">ë„¤ì´ë²„ ë§›ì§‘ ê²€ìƒ‰</h2>

<form method="get" action="{% url 'restaurant_search' %}" style="display:flex; gap:8px; margin-bottom:12px;">
  <input type="text" name="query" value="{{ query }}" placeholder="ì˜ˆ: ì „ë¶ëŒ€, ì „ì£¼, ê°ì‚¬"
         style="flex:1; padding:10px 12px; border:1px solid #d1d5db; border-radius:8px;">
  <button type="submit"
          style="padding:10px 14px; border:none; border-radius:8px; background:#2563eb; color:white; font-weight:700; cursor:pointer;">
    ê²€ìƒ‰
  </button>
</form>

<style>
  #map-wrap { position: relative; }
  #map { width:100%; height:420px; border:1px solid #e5e7eb; border-radius:10px; margin-bottom:16px; }
  #btn-my-location {
    position: absolute;
    right: 14px;
    top: 14px;
    z-index: 2000;
    width: 44px;
    height: 44px;
    border: 1px solid rgba(0,0,0,0.15);
    border-radius: 12px;
    background: white;
    cursor: pointer;
    box-shadow: 0 6px 18px rgba(0,0,0,0.12);
    display: flex;
    align-items: center;
    justify-content: center;
  }
  #btn-my-location:hover { transform: translateY(-1px); }
  #btn-my-location:active { transform: translateY(0px); }
  #btn-my-location span {
    font-size: 18px;
    line-height: 1;
  }
</style>

<script src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpKeyId={{ NAVER_MAP_CLIENT_ID }}"></script>

<div id="map-wrap">
  <button id="btn-my-location" type="button" title="ë‚´ ìœ„ì¹˜ë¡œ ì´ë™">
    <span>ğŸ“</span>
  </button>
  <div id="map"></div>
</div>

<h3 style="margin:0 0 10px 0;">ê²€ìƒ‰ ê²°ê³¼</h3>
<div id="list"></div>

<script id="places-data" type="application/json">{{ places_json|safe }}</script>

<script>
  const placesEl = document.getElementById("places-data");
  const places = placesEl && placesEl.textContent.trim() ? JSON.parse(placesEl.textContent) : [];

  const defaultCenter = new naver.maps.LatLng(35.8402, 127.1327);
  const map = new naver.maps.Map("map", { center: defaultCenter, zoom: 13 });

  let markers = [];
  let currentInfo = null;
  let myLocationMarker = null;

  function stripTags(s) {
    return String(s || "").replace(/<[^>]*>?/g, "").trim();
  }

  function clearResultMarkers() {
    markers.forEach(m => m.setMap(null));
    markers = [];
    if (currentInfo) { currentInfo.close(); currentInfo = null; }
  }

  function renderList(items) {
    const list = document.getElementById("list");
    if (!list) return;

    if (!items || items.length === 0) {
      list.innerHTML = '<p style="color:#6b7280;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
      return;
    }

    list.innerHTML = items.map((p, idx) => {
      const title = stripTags(p.title);
      const addr = p.roadAddress || p.address || "";
      const cat = p.category || "";
      const url = p.link ? p.link : `https://map.naver.com/v5/search/${encodeURIComponent(title)}`;
      return `
        <a href="${url}" target="_blank" style="text-decoration:none; color:inherit;">
          <div style="border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px; margin-bottom:8px;">
            <div style="display:flex; justify-content:space-between; gap:10px;">
              <div style="font-weight:800;">${idx+1}. ${title}</div>
              <div style="font-size:12px; color:#2563eb; background:#eff6ff; padding:2px 6px; border-radius:6px; white-space:nowrap;">${cat}</div>
            </div>
            <div style="margin-top:4px; font-size:13px; color:#4b5563;">${addr}</div>
          </div>
        </a>
      `;
    }).join("");
  }

  function renderResultMarkers(items) {
    clearResultMarkers();

    const limited = (items || []).slice(0, 10);
    let firstLatLng = null;

    limited.forEach((p, idx) => {
      if (!p.mapx || !p.mapy) return;

      const x = Number(p.mapx);
      const y = Number(p.mapy);
      if (Number.isNaN(x) || Number.isNaN(y)) return;

      const lng = x / 10000000;
      const lat = y / 10000000;

      if (lat < 33 || lat > 39 || lng < 124 || lng > 132) return;

      const latlng = new naver.maps.LatLng(lat, lng);

      if (!firstLatLng) {
        firstLatLng = latlng;
        map.setCenter(latlng);
        map.setZoom(14);
      }

      const marker = new naver.maps.Marker({ position: latlng, map: map });

      const title = stripTags(p.title);
      const addr = p.roadAddress || p.address || "";

      const info = new naver.maps.InfoWindow({
        content: `<div style="padding:8px; font-size:13px; max-width:240px;">
                    <div style="font-weight:800; margin-bottom:4px;">${idx+1}. ${title}</div>
                    <div style="color:#4b5563;">${addr}</div>
                  </div>`
      });

      naver.maps.Event.addListener(marker, "click", () => {
        if (currentInfo) currentInfo.close();
        info.open(map, marker);
        currentInfo = info;
      });

      markers.push(marker);
    });

    setTimeout(() => naver.maps.Event.trigger(map, "resize"), 0);
  }

  function moveToMyLocation() {
    if (!navigator.geolocation) {
      alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      return;
    }

    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        const myLatLng = new naver.maps.LatLng(lat, lng);

        map.setCenter(myLatLng);
        map.setZoom(15);

        if (myLocationMarker) myLocationMarker.setMap(null);

        myLocationMarker = new naver.maps.Marker({
          position: myLatLng,
          map: map,
          zIndex: 3000,
          icon: {
            content: '<div style="width:16px;height:16px;background:#03C75A;border-radius:50%;border:3px solid white;box-shadow:0 0 6px rgba(0,0,0,0.5);"></div>',
            anchor: new naver.maps.Point(8, 8)
          }
        });

        setTimeout(() => naver.maps.Event.trigger(map, "resize"), 0);
      },
      () => alert("í˜„ì¬ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”."),
      { enableHighAccuracy: true, timeout: 10000 }
    );
  }

  document.getElementById("btn-my-location").addEventListener("click", moveToMyLocation);

  renderList(places);
  renderResultMarkers(places);
</script>
{% endblock %}
