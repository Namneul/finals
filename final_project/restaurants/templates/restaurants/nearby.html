{% extends 'base.html' %}

{% block title %}내 주변 맛집 | finals 맛집{% endblock %}

{% block content %}
<h2 style="margin-bottom: 8px;">내 주변 맛집</h2>

{% if lat and lng %}
    <p style="font-size:14px; color:#4b5563;">
        현재 위치: ({{ lat }}, {{ lng }}) / 반경 {{ radius }}m 기준
    </p>
{% else %}
    <p>현재 위치 정보가 없어 기본 지도만 표시합니다.</p>
{% endif %}

<script
    type="text/javascript"
    src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpKeyId={{ NAVER_MAP_CLIENT_ID }}">
</script>

<div id="map" style="width:100%; height:400px; margin:12px 0;"></div>

<h3 style="margin-top:16px;">검색 결과</h3>

<div id="place-list">
    <!-- 리스트는 JS에서 places 데이터를 기반으로 채우거나,
         혹은 서버에서 따로도 렌더링할 수 있음 -->
</div>

<!-- 파이썬에서 준비한 JSON 문자열 -->
<script id="places-data" type="application/json">
    {{ places_json|safe }}
</script>

<script type="text/javascript">
    var map;
    var markers = [];

    function initMap() {
        var center;

        {% if lat and lng %}
            center = new naver.maps.LatLng({{ lat }}, {{ lng }});
        {% else %}
            center = new naver.maps.LatLng(35.8402, 127.1327);  // 전주 기본값
        {% endif %}

        map = new naver.maps.Map('map', {
            center: center,
            zoom: 14
        });

        // 현재 위치 마커
        {% if lat and lng %}
        new naver.maps.Marker({
            position: center,
            map: map,
            icon: {
                content: '<div style="width:14px;height:14px;background:#2563eb;border-radius:999px;border:2px solid white;box-shadow:0 0 4px rgba(0,0,0,0.3);"></div>',
                anchor: new naver.maps.Point(7, 7)
            }
        });
        {% endif %}

        // 네이버 Local API 결과를 가져와 마커 찍기
        var placesDataElement = document.getElementById('places-data');
        var places = [];
        if (placesDataElement && placesDataElement.textContent.trim()) {
            places = JSON.parse(placesDataElement.textContent);
        }

        var listContainer = document.getElementById('place-list');

        if (places.length === 0) {
            listContainer.innerHTML = '<p>검색 결과가 없습니다.</p>';
            return;
        }

        var bounds = new naver.maps.LatLngBounds();
        var listHtml = '';

        places.forEach(function (place, index) {
            // Local API의 mapx, mapy(Tm128) -> LatLng 변환
            var tm128 = new naver.maps.Point(Number(place.mapx), Number(place.mapy));
            var latlng = naver.maps.TransCoord.fromTM128ToLatLng(tm128);

            var marker = new naver.maps.Marker({
                position: latlng,
                map: map
            });
            markers.push(marker);

            bounds.extend(latlng);

            var title = place.title.replace(/<[^>]*>?/g, '');  // <b> 태그 제거
            var address = place.roadAddress || place.address || '';
            var tel = place.telephone || '';

            // 리스트 HTML 구성
            listHtml += `
                <div style="border:1px solid #e5e7eb; padding:8px; margin-bottom:8px; border-radius:8px;">
                    <strong>${index + 1}. ${title}</strong><br>
                    <span style="font-size:13px; color:#4b5563;">${address}</span><br>
                    <span style="font-size:13px; color:#6b7280;">${tel}</span><br>
                </div>
            `;

            // 마커 클릭 시 지도 중앙 이동 + 간단한 인포윈도우
            var infowindow = new naver.maps.InfoWindow({
                content: `<div style="padding:6px;font-size:13px;">${title}</div>`
            });

            naver.maps.Event.addListener(marker, 'click', function () {
                map.setCenter(latlng);
                map.setZoom(16);
                infowindow.open(map, marker);
            });
        });

        map.fitBounds(bounds);

        listContainer.innerHTML = listHtml;
    }

    // 지도 초기화
    initMap();
</script>
{% endblock %}
