{% extends 'base.html' %}

{% block title %}지도 테스트 | finals 맛집{% endblock %}

{% block content %}
<h2 style="margin-bottom: 16px;">네이버 지도 테스트</h2>

<!-- 현재 위치로 이동 -->
<button class="btn" id="btn-current-location" style="margin-bottom: 8px;">
    현재 위치로 이동
</button>

<!-- 근처 맛집 보기 (반경 1km 예시) -->
<button class="btn" id="btn-nearby-restaurants" style="margin-left: 8px; margin-bottom: 8px;">
    내 주변 맛집 보기
</button>

<script
    type="text/javascript"
    src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpKeyId={{ NAVER_MAP_CLIENT_ID }}">
</script>

<div id="map" style="width:100%; height:500px; margin-top:12px;"></div>

<script type="text/javascript">
    var defaultCenter = new naver.maps.LatLng(35.8402, 127.1327);

    var map = new naver.maps.Map('map', {
        center: defaultCenter,
        zoom: 14
    });

    var defaultMarker = new naver.maps.Marker({
        position: defaultCenter,
        map: map
    });

    var currentLocationMarker = null;
    var currentLat = null;
    var currentLng = null;

    function moveToCurrentLocation(callback) {
        if (!navigator.geolocation) {
            alert("이 브라우저에서는 위치 정보를 사용할 수 없습니다.");
            return;
        }

        navigator.geolocation.getCurrentPosition(
            function (position) {
                var lat = position.coords.latitude;
                var lng = position.coords.longitude;

                currentLat = lat;
                currentLng = lng;

                var userLatLng = new naver.maps.LatLng(lat, lng);

                map.setCenter(userLatLng);
                map.setZoom(16);

                if (currentLocationMarker) {
                    currentLocationMarker.setMap(null);
                }

                currentLocationMarker = new naver.maps.Marker({
                    position: userLatLng,
                    map: map,
                    icon: {
                        content: '<div style="width:14px;height:14px;background:#2563eb;border-radius:999px;border:2px solid white;box-shadow:0 0 4px rgba(0,0,0,0.3);"></div>',
                        anchor: new naver.maps.Point(7, 7)
                    }
                });

                if (typeof callback === 'function') {
                    callback(lat, lng);
                }
            },
            function (error) {
                switch (error.code) {
                    case error.PERMISSION_DENIED:
                        alert("위치 정보 사용이 거부되었습니다. 브라우저 설정을 확인해주세요.");
                        break;
                    case error.POSITION_UNAVAILABLE:
                        alert("위치 정보를 사용할 수 없습니다.");
                        break;
                    case error.TIMEOUT:
                        alert("위치 정보를 가져오는 데 시간이 초과되었습니다.");
                        break;
                    default:
                        alert("위치 정보를 가져오는 중 알 수 없는 오류가 발생했습니다.");
                }
            }
        );
    }

    // 현재 위치로 이동 버튼
    document.getElementById("btn-current-location")
            .addEventListener("click", function () {
                moveToCurrentLocation();
            });

    // 내 주변 맛집 보기 버튼
    document.getElementById("btn-nearby-restaurants")
            .addEventListener("click", function () {
                // 이미 currentLat / currentLng 가 있으면 바로 사용
                if (currentLat && currentLng) {
                    var radius = 1000;  // 1km 예시
                    var url = `/restaurants/nearby/?lat=${currentLat}&lng=${currentLng}&radius=${radius}`;
                    window.location.href = url;   // ★ AJAX 아님, 그냥 페이지 이동
                } else {
                    // 아직 위치가 없으면 먼저 위치부터 가져온 뒤 이동
                    moveToCurrentLocation(function (lat, lng) {
                        var radius = 1000;
                        var url = `/restaurants/nearby/?lat=${lat}&lng=${lng}&radius=${radius}`;
                        window.location.href = url;
                    });
                }
            });
</script>
{% endblock %}
